<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="generator" content="Hugo 0.56.3" />
    
    
    <link rel="stylesheet" href="https://damnotes.netlify.com/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://damnotes.netlify.com/css/style.css">
    
    
    <title>Threading and Multiprocessing | DamNotes</title>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js">
    </script>
</head>

<body>
    
<div class="container border-bottom border-dark">
    <nav class="navbar navbar-light">
        <a class="navbar-brand" href="https://damnotes.netlify.com/">DamNotes</a>
        
        <ul class="navbar-nav">
            
            
            
            <li class=" nav-item active">
                <a class="nav-link" href="/about/"><i data-feather="user"></i> About<span
                        class="sr-only">(current)</span></a>
            </li>
            
        </ul>
    </nav>
</div>
    <div class="container">
        <main id="main">
            
<div class="d-flex flex-column align-items-center">
    <h2 class="m-1 mb-2 mt-2"><u>Threading and Multiprocessing</u></h2>
</div>


<p>Tasks can be <strong>CPU bound</strong> (performance related to how fast the CPU is, e.g. crunching numbers) or <strong>I/O bound</strong> (performance related to how fast are I/O operations, e.g. reading/writing on files, accessing to the network). In the second case, if there are &ldquo;dead periods&rdquo; in which the CPU just has to wait, threading can represent a huge boost in performace: those moments are replaced by other tasks that can be executed concurrently.</p>

<p><strong>Threading</strong> refers to this concepts, and it is technically different from <strong>multiprocessing</strong>: in this second case, operations are done on two physically different cores so that they really happen at the same time.</p>

<hr />

<h3 id="threading">Threading</h3>

<p>(<a href="https://docs.python.org/3/library/threading.html">Docs</a>)</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">threading</span>

<span style="color:#408080;font-style:italic"># Create the thread object</span>
t1 <span style="color:#666">=</span> threading<span style="color:#666">.</span>Thread(target<span style="color:#666">=</span>my_function, args<span style="color:#666">=</span>[func_arg1, func_arg2,<span style="color:#666">...</span>])
<span style="color:#408080;font-style:italic"># Start the thread</span>
t1<span style="color:#666">.</span>start()</code></pre></div>
<p><em>my_function</em> is a function defined previously in the program.</p>

<ul>
<li><p><code>t1.join()</code> &rarr; block the execution of the calling thread until <em>t1</em> is completed. Can have an optional timeout (<a href="https://docs.python.org/3/library/threading.html#threading.Thread.join">doc</a>)</p></li>

<li><p>One can create various &ldquo;unnamed&rdquo; threads and call <code>join</code> on each of them</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">threads <span style="color:#666">=</span> []
<span style="color:#008000;font-weight:bold">for</span> _ <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">range</span>(<span style="color:#666">10</span>):
    t <span style="color:#666">=</span> threading<span style="color:#666">.</span>Thread(target<span style="color:#666">=...</span>)
    t<span style="color:#666">.</span>start()
    threads<span style="color:#666">.</span>append(t)

<span style="color:#008000;font-weight:bold">for</span> thread <span style="color:#a2f;font-weight:bold">in</span> threads:
    thread<span style="color:#666">.</span>join()</code></pre></div></li>
</ul>

<h4 id="thread-pool-executor">Thread Pool Executor</h4>

<p>(<a href="https://docs.python.org/3/library/concurrent.futures.html#module-concurrent.futures">Docs</a>)</p>

<p>This is a newer an easier way to execute threads introduced in Python 3.2. One can then easily switch to multiprocessing if necessary.</p>

<p>This is usually best implemented with the <em>context manager</em> <code>with</code>.</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">concurrent.futures</span>

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">my_function</span>(arg1, arg2,<span style="color:#666">...</span>):
    <span style="color:#666">&lt;</span>code<span style="color:#666">&gt;</span>
    <span style="color:#008000;font-weight:bold">return</span> something

<span style="color:#008000;font-weight:bold">with</span> concurrent<span style="color:#666">.</span>futures<span style="color:#666">.</span>ThreadPoolExecutor() <span style="color:#008000;font-weight:bold">as</span> executor:
    f1 <span style="color:#666">=</span> executor<span style="color:#666">.</span>submit(my_function, arg1, arg2,<span style="color:#666">...</span>)
    <span style="color:#008000;font-weight:bold">print</span>(f1<span style="color:#666">.</span>result())</code></pre></div>
<ul>
<li><p><code>executor.submit()</code> &rarr; schedule a function to be executed. Returns a <em>future object</em> (it allows to check the status of the thread, <a href="https://docs.python.org/3/library/concurrent.futures.html#future-objects">doc</a>). In practice, it create the thread and run it automatically (<a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">doc</a>)</p></li>

<li><p><code>f1.result()</code> &rarr; wait until the thread is complete and return its output (<a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Future.result">doc</a>)</p></li>
</ul>

<hr />

<p>To run multiple threads, list comprehension can be used</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#008000;font-weight:bold">with</span> concurrent<span style="color:#666">.</span>futures<span style="color:#666">.</span>ThreadPoolExecutor() <span style="color:#008000;font-weight:bold">as</span> executor:
    results <span style="color:#666">=</span> [executor<span style="color:#666">.</span>submit(<span style="color:#666">...</span>) <span style="color:#008000;font-weight:bold">for</span> _ <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">range</span>(<span style="color:#666">10</span>)]

    <span style="color:#008000;font-weight:bold">for</span> f <span style="color:#a2f;font-weight:bold">in</span> concurrent<span style="color:#666">.</span>futures<span style="color:#666">.</span>as_completed(results):
        <span style="color:#008000;font-weight:bold">print</span>(f<span style="color:#666">.</span>result())</code></pre></div>
<ul>
<li><p><code>concurrent.futures.as_completed(future_object_list)</code> &rarr; return an iterator that will yeld the reference to the threads as they are completed (<a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.as_completed">doc</a>)</p></li>

<li><p><code>executor.map(my_function, list)</code> &rarr; run an executor for each item contained in <em>list</em>. It is used to launch various different thread in one single line. It returns a list with the results of each thread, <em>in the order in which they were launched</em> (<a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">doc</a>)</p></li>
</ul>

<hr />

<h3 id="multiprocessing">Multiprocessing</h3>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">multiprocessing</span>

<span style="color:#408080;font-style:italic"># Create the process object</span>
p1 <span style="color:#666">=</span> multiprocessing<span style="color:#666">.</span>Process(target<span style="color:#666">=</span>my_function, args<span style="color:#666">=</span>[arg1, arg2,<span style="color:#666">...</span>])
<span style="color:#408080;font-style:italic"># Start that process</span>
p1<span style="color:#666">.</span>start()</code></pre></div>
<p><em>my_function</em> is a function defined previously in the program.</p>

<ul>
<li><code>p1.join()</code> &rarr; block the execution of the calling process until <em>p1</em> is completed</li>
</ul>

<h4 id="process-pool-executor">Process Pool Executor</h4>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">concurrent.futures</span>

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">my_function</span>(arg1, arg2,<span style="color:#666">...</span>):
    <span style="color:#666">&lt;</span>code<span style="color:#666">&gt;</span>
    <span style="color:#008000;font-weight:bold">return</span> something

<span style="color:#008000;font-weight:bold">with</span> concurrent<span style="color:#666">.</span>futures<span style="color:#666">.</span>ProcessPoolExecutor() <span style="color:#008000;font-weight:bold">as</span> executor:
    f1 <span style="color:#666">=</span> executor<span style="color:#666">.</span>submit(my_function, arg1, arg2,<span style="color:#666">...</span>)
    <span style="color:#008000;font-weight:bold">print</span>(f1<span style="color:#666">.</span>result())</code></pre></div>
<p>In practice, all things said in the <em>Thread Pool Executor</em> section are applicable also here.</p>

<hr />

<h3 id="sources">Sources</h3>

<ul>
<li><p><a href="https://youtu.be/IEEhzQoKtQU">Python Threading Tutorial</a> - Corey Shafer</p></li>

<li><p><a href="https://youtu.be/fKl2JW_qrso">Python Multiprocessing Tutorial</a> - Corey Shafer</p></li>
</ul>



        </main>
    </div>
    <div class="container border-top border-dark">
    <nav class="navbar navbar-light justify-content-center">
        <div class="navbar-nav d-flex flex-row justify-content-center">
            
            
            
            <a class="nav-item nav-link active" href="https://github.com/damianolodi"
                style="margin:10px;"><i data-feather="github"></i> GitHub</a>
            
            
            
            <a class="nav-item nav-link active" href="https://www.linkedin.com/in/damiano-lodi/"
                style="margin:10px;"><i data-feather="linkedin"></i> LinkedIn</a>
            
        </div>
    </nav>
</div>
    

<script src="https://damnotes.netlify.com/js/feather.min.js"></script>
<script>
    feather.replace()
</script>
</body>

</html>